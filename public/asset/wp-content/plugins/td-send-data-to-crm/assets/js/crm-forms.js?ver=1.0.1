jQuery(function($){

  var loading = false;

    $(".js-crmtronic-lead-form").on("submit", function (e) {
      e.preventDefault();

      var action = $(this).attr("action");

      var name       = $(this).find('[name="fullName"]').val();
      var phone      = $(this).find('[name="contacts[phone][main]"]').val();
      var email      = $(this).find('[name="contacts[email][main]"]').val();
      var city_from  = $(this).find('.form-from').val();
      var where      = $(this).find('.form-where').val();
      var when       = $(this).find('.form-when').val();
      var date_back  = $(this).find('.form-back').val();
      var persons    = $(this).find('.form-persons').val();
      var children   = $(this).find('.form-children').val();
      var form_title = $(this).find('.form-topic').val();
      var meta       = '';

      if ( city_from ) {
        meta += 'откуда: ' + city_from + '; ';
      }
      if ( where ) {
        meta += 'куда: ' + where + '; ';
      }
      if ( when ) {
        meta += 'когда: ' + when + '; ';
      }
      if ( date_back ) {
        meta += 'обратно: ' + date_back + '; ';
      }
      if ( persons ) {
        meta += 'чел: ' + persons + '; ';
      }
      if ( children ) {
        meta += 'дети: ' + children + '; ';
      }

      if (meta) {
        $(this).find('.form-topic').val(meta)
      }

      var data    = $(e.target).serialize();

      if( ! loading ) {

        loading = true;
        var data_b = {
          action: 'td_ajax_send_data',
          nonce: tdcrm.nonce,
          name: name,
          phone: phone,
          email: email,
          city_from: city_from,
          where: where,
          when: when,
          date_back: date_back,
          persons: persons,
          children: children,
          form_title: form_title,
        };

        $.post(tdcrm.url, data_b, function(res) {

          $('#form-message').find('.form-message__head').html(res.data.title);
          $('#form-message').find('.form-message__desc').html(res.data.message);
          if( res.success) {
            $('#form-message').addClass('shown success');
            loading = false;
          } else {
            $('#form-message').addClass('shown error');
            loading = false;
          }
        }).fail(function(xhr, textStatus, e) {

        });

        $.ajax({
          type: "POST",
          url: action,
          crossDomain: true,
          data: data
        })
        .done(function done () {
        })
        .fail(function error (jqXHR) {
        });

      }

      return false;
    });
});
