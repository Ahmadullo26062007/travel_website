(function ( $ ) {

    $.fn.cityAutocomplete = function(options) {
        var autocompleteService = new google.maps.places.AutocompleteService();
        var predictionsDropDown = $('<div class="city-autocomplete"></div>').appendTo('body');
        var input = $(this);

        input.keyup(function() {
            var searchStr = $(this).val();

            if (searchStr.length > 0) {
                var params = {
                    input: searchStr,
                    types: ['(cities)'],
                    key: 'AIzaSyDerpC--ypNXN-iHLscq3bmqWgTYwLePcQ',
                };

                autocompleteService.getPlacePredictions(params, updatePredictions);
            } else {
                predictionsDropDown.hide();
            }
        });

        predictionsDropDown.delegate('div', 'click', function() {
            input.val($(this).text());
            predictionsDropDown.hide();
        });

        $(document).mouseup(function (e) {
            if (!predictionsDropDown.is(e.target) && predictionsDropDown.has(e.target).length === 0) {
                predictionsDropDown.hide();
            }
        });

        $(window).resize(function() {
            updatePredictionsDropDownDisplay(predictionsDropDown, input);
        });

        updatePredictionsDropDownDisplay(predictionsDropDown, input);

        function updatePredictions(predictions, status) {
            if (google.maps.places.PlacesServiceStatus.OK != status) {
                predictionsDropDown.hide();
                return;
            }

            predictionsDropDown.empty();
            $.each(predictions, function(i, prediction) {
                var city = prediction.structured_formatting.main_text;
                var country = prediction.structured_formatting.secondary_text;
                predictionsDropDown.append('<div>' + city + ', <span>' + country + '</span></div');
            });

            predictionsDropDown.show();
        }

        return input;
    };

    function updatePredictionsDropDownDisplay(dropDown, input) {
        dropDown.css({
            'width': input.outerWidth(),
            'left': input.offset().left,
            'top': input.offset().top + input.outerHeight()
        });
    }

    $('input.form-city1').cityAutocomplete();
    $('input.form-city2').cityAutocomplete();

}( jQuery ));
